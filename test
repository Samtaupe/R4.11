<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema</title>
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
</head>
<body>
    <ons-navigator id="myNavigator" page="acteurs.html" swipeable/>
    <template id="acteurs.html">
        <ons-page id="page_acteurs">
            <ons-toolbar>
                <div class="center">Acteurs</div>
            </ons-toolbar>
            <ons-list>
                <ons-lazy-repeat></ons-lazy-repeat>
            </ons-list>
        </ons-page>
    </template>

    <template id="item_acteur">
        <ons-list-item>
            <div class="left">
                <img class="list-item__thumbnail" src="https://morseweiswlpykaugwtd.supabase.co/storage/v1/object/public/personnes/_inconnu.jpg">
            </div>
            <div class="center">
                <span class="list-item__title"></span>
                <span class="list-item__subtitle"></span>
            </div>
        </ons-list-item>
    </template>

    <script>
    
    let personnes=[];
    
    document.addEventListener('init', function(event) {
        var page = event.target;
        
        if (page.id === 'page_acteurs') {
            getActeurs(page);
        }    
            
    });

    async function getActeurs(page){
               
        const data = await fetch("https://morseweiswlpykaugwtd.supabase.co/rest/v1/acteur?select=*",
            { 
                headers: { apikey:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vcnNld2Vpc3dscHlrYXVnd3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDY5NTcxMjgsImV4cCI6MjAyMjUzMzEyOH0.UV5XCINWe-Jaw6_-787Veh-LxjzUVudArvrgH6Ycf30'}
            });
        personnes = await data.json();

        var infiniteList = page.querySelector('ons-lazy-repeat');
        infiniteList.delegate = {
            createItemContent: createItemActeur,
            countItems: function() {
                return personnes.length;
            }
        };    
 
    }

    function loadImage(element, source){
        var portrait = new Image();
        portrait.src= source;
        portrait.onload = function(){
            element.src = source;
        }
    }

    function createItemActeur(index){
        const acteur = personnes[index];
        var nouvelElement = document.getElementById("item_acteur").content.cloneNode(true)

        nouvelElement.querySelector(".list-item__title").textContent = acteur.nom 
        nouvelElement.querySelector(".list-item__subtitle").textContent = acteur.age??'décédé'
        loadImage(nouvelElement.querySelector(".list-item__thumbnail"),`https://morseweiswlpykaugwtd.supabase.co/storage/v1/object/public/personnes/${acteur.personne_id}.jpg`)

        return nouvelElement.firstElementChild;
    }

    </script>
</body>
</html>
